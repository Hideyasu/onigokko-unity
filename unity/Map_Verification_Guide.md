# Map検証ガイド: GPS位置情報システム

## 概要
「鬼vs陰陽師」ゲーム用のGPS位置情報システムとマップ表示機能の検証ガイドです。

## 必要な機材
- iOS/Androidデバイス（GPS機能付き）
- 屋外環境（GPS受信可能な場所）
- Unity Editor（シミュレーションテスト用）

## セットアップ手順

### 1. Unity Editor でのテスト
```
1. MapVerification.unity シーンを開く
2. Map System Manager に以下コンポーネントを追加：
   - GPSLocationService
   - MapVerificationSystem
3. Play ボタンをクリック
4. シミュレーションモードで基本動作を確認
```

### 2. 実機ビルド設定

#### iOS設定
```
- Build Settings → iOS
- Player Settings で位置情報権限を確認
- Info.plist に以下が自動追加されることを確認：
  - NSLocationWhenInUseUsageDescription
  - NSLocationAlwaysAndWhenInUseUsageDescription
```

#### Android設定
```
- Build Settings → Android
- Player Settings で以下権限を有効化：
  - ACCESS_FINE_LOCATION
  - ACCESS_COARSE_LOCATION
```

## 検証項目

### Phase 1: GPS基本機能テスト

#### 1.1 GPS初期化テスト
```
手順:
1. アプリ起動
2. 位置情報権限を「使用中のみ許可」で許可
3. Debug UI で GPS状態を確認

期待結果:
- GPS有効: True
- GPS状態: Running
- 現在位置が表示される
- 精度が10m以下
```

#### 1.2 位置情報更新テスト
```
手順:
1. GPS初期化完了後
2. デバイスを持って50m程度移動
3. Debug UI で位置情報の更新を確認

期待結果:
- 現在位置が継続的に更新される
- 移動に応じて座標が変化
- 精度が安定している（10m以下）
```

#### 1.3 権限エラーテスト
```
手順:
1. 設定で位置情報権限を無効化
2. アプリ再起動
3. エラーメッセージを確認

期待結果:
- 適切なエラーメッセージ表示
- GPS状態が Failed
- ユーザーに権限設定を促すメッセージ
```

### Phase 2: マップシステムテスト

#### 2.1 ゲームエリア境界テスト
```
手順:
1. ゲームエリア中心（東京駅周辺）に移動
2. Debug UI で「ゲームエリア内: True」を確認
3. 500m外に移動
4. 「ゲームエリア内: False」を確認

期待結果:
- 境界判定が正確
- 中心からの距離が正しく表示
- エリア外での警告表示
```

#### 2.2 簡易マップ表示テスト
```
手順:
1. 簡易マップ（右上）を確認
2. 現在位置マーカー（緑）が表示されることを確認
3. ゲームエリア中心マーカー（青）を確認
4. 移動時のマーカー追従を確認

期待結果:
- マーカーが正しい位置に表示
- 移動に応じてマーカーが移動
- ゲームエリア円が表示
```

#### 2.3 テストプレイヤー距離計算テスト
```
手順:
1. MapVerificationSystem の testPlayers を設定
2. Debug UI でプレイヤー間距離を確認
3. 実際の距離と比較検証

期待結果:
- 距離計算が±10m以内の精度
- 複数プレイヤーとの距離が同時表示
- リアルタイム更新
```

### Phase 3: パフォーマンステスト

#### 3.1 バッテリー消費テスト
```
手順:
1. フル充電状態から開始
2. 30分間連続使用
3. バッテリー消費量を記録

期待結果:
- 30分で15%以下の消費
- GPS更新間隔の最適化
- バックグラウンド動作時の省電力
```

#### 3.2 精度安定性テスト
```
手順:
1. 同じ場所で5分間静止
2. 位置情報の変動を記録
3. 精度の安定性を確認

期待結果:
- 位置の変動が5m以下
- 精度値が安定
- 異常な値の除外
```

### Phase 4: エラーハンドリングテスト

#### 4.1 GPS信号遮断テスト
```
手順:
1. 屋内（地下など）に移動
2. GPS信号が遮断された状態を確認
3. エラーハンドリングを確認

期待結果:
- 適切なエラーメッセージ
- GPS状態の正確な表示
- 信号回復時の自動復旧
```

#### 4.2 ネットワーク切断テスト
```
手順:
1. 機内モード ON
2. GPS機能の動作確認
3. 位置情報取得の継続確認

期待結果:
- GPS は継続動作
- ネットワーク不要な機能は正常動作
- 適切なエラーハンドリング
```

## デバッグUI説明

### GPS Location Service セクション
- **GPS有効**: デバイスの位置情報設定
- **GPS状態**: Initializing/Running/Failed/Stopped
- **現在位置**: 緯度・経度座標
- **精度**: 水平精度（メートル）

### Map Verification セクション
- **ゲームエリア内**: 境界判定結果
- **中心からの距離**: ゲームエリア中心からの距離
- **エリア半径**: ゲームエリアの半径設定

### 簡易マップ
- **緑マーカー**: 現在位置
- **青マーカー**: ゲームエリア中心
- **赤マーカー**: テストプレイヤー
- **青円**: ゲームエリア境界

## トラブルシューティング

### GPS が開始しない
```
原因: 位置情報権限が無効
解決策:
1. 設定 → プライバシー → 位置情報サービス → ON
2. アプリ個別設定で「使用中のみ許可」を選択
3. アプリ再起動
```

### 精度が悪い（50m以上）
```
原因: GPS信号が不安定
解決策:
1. 屋外の開けた場所に移動
2. 3-5分待機してGPS測位を安定させる
3. デバイスを再起動
```

### 位置情報が更新されない
```
原因: GPS設定の問題
解決策:
1. desiredAccuracyInMeters を 10 に変更
2. updateDistanceInMeters を 5 に変更
3. シミュレーションモードで動作確認
```

### マップマーカーが表示されない
```
原因: 座標変換の問題
解決策:
1. ゲームエリア中心座標を現在地に設定
2. mapRange値を調整（0.001-0.01）
3. WorldToScreenPosition の計算を確認
```

## 成功基準

### 必須項目
- [ ] GPS初期化が20秒以内に完了
- [ ] 位置情報精度が10m以下
- [ ] ゲームエリア境界判定が正確
- [ ] バッテリー消費が30分で15%以下

### 推奨項目
- [ ] 位置情報精度が5m以下
- [ ] マップマーカーが正確に表示
- [ ] エラーハンドリングが適切
- [ ] UI が分かりやすい

## 次のステップ

検証完了後の統合作業：
1. **BLE Beacon との統合**: 距離補正システム
2. **Firebase との統合**: リアルタイム位置共有
3. **心音システムとの統合**: 距離に応じた心音制御
4. **ゲームロジックとの統合**: 境界警告、勝利条件判定

---

**注意**: GPS機能は屋外での使用を前提としています。屋内では精度が大幅に低下する可能性があります。